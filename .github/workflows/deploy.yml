name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ANASLABS_VPS
    
    # Inject API URL for frontend build globally for this job
    env:
      VITE_API_URL: http://${{ secrets.VPS_HOST }}:3001/api/v1
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_KEY: ${{ secrets.VPS_KEY }}

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter @alizzah/db generate

      - name: Build all packages
        run: |
           pnpm build 
           # Explicitly build api-client too just heavily make sure
           pnpm build --filter @alizzah/api-client

      # OPTIONAL DEBUG: Check if output folders exist
      - name: Check Output Folders
        run: |
          echo "Checking Web Output..."
          ls -F apps/web-keuangan/.output || echo "Web .output not found"
          ls -F apps/web-keuangan/dist || echo "Web dist not found"

          echo "Checking API Output..."
          ls -F apps/api/dist || echo "API dist not found"

      - name: Prepare SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "$VPS_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts

      - name: Sync Build Artifacts to VPS
        run: |
          # Sync Web Output (Try .output first, typical for Vinxi/Nitro)
          if [ -d "apps/web-keuangan/.output" ]; then
             rsync -avz --delete ./apps/web-keuangan/.output/ $VPS_USER@$VPS_HOST:~/alizzah/apps/web-keuangan/.output/
          elif [ -d "apps/web-keuangan/dist" ]; then
             rsync -avz --delete ./apps/web-keuangan/dist/ $VPS_USER@$VPS_HOST:~/alizzah/apps/web-keuangan/dist/
          else
             echo "ERROR: No web build output found!"
             exit 1
          fi
          
          # Sync API Dist
          rsync -avz --delete ./apps/api/dist/ $VPS_USER@$VPS_HOST:~/alizzah/apps/api/dist/
          
          # Sync Packages Dist
          rsync -avz --delete ./packages/db/dist/ $VPS_USER@$VPS_HOST:~/alizzah/packages/db/dist/
          rsync -avz --delete ./packages/shared/dist/ $VPS_USER@$VPS_HOST:~/alizzah/packages/shared/dist/
          rsync -avz --delete ./packages/validators/dist/ $VPS_USER@$VPS_HOST:~/alizzah/packages/validators/dist/
          rsync -avz --delete ./packages/api-client/dist/ $VPS_USER@$VPS_HOST:~/alizzah/packages/api-client/dist/
          
          # Sync Ecosystem Config
          rsync -avz ./ecosystem.config.cjs $VPS_USER@$VPS_HOST:~/alizzah/

      - name: Reload Application on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
             # Load NVM (Node Version Manager)
             export NVM_DIR="$HOME/.nvm"
             [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

             # Ensure pnpm is in PATH
             export PATH=$HOME/.local/share/pnpm:$PATH
             
             cd ~/alizzah
             
             # Pull latest code
             git fetch origin main
             git reset --hard origin/main
             
             # Symlinks
             ln -sf .env apps/api/.env
             ln -sf ../../.env apps/web-keuangan/.env
             ln -sf ../../.env packages/db/.env

             # Install Production Deps
             pnpm install --prod --ignore-scripts
             
             # Reload PM2
             pm2 reload ecosystem.config.cjs
             pm2 save
