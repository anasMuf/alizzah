name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  # =================================================================================
  # JOB 1: BUILD FRONTEND (WEB REUANGAN)
  # =================================================================================
  build-web:
    runs-on: ubuntu-latest
    environment: ANASLABS_VPS
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v3
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client (Needed for types)
        run: pnpm --filter @alizzah/db generate

      - name: Build Web Only
        env:
          VITE_API_URL: http://${{ secrets.VPS_HOST }}:3001/api/v1
        run: pnpm build --filter @alizzah/web-keuangan

      - name: Debug Output Directory
        run: ls -Fal apps/web-keuangan

      - name: Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: |
            apps/web-keuangan/.output/
            apps/web-keuangan/dist/
          retention-days: 1

  # =================================================================================
  # JOB 2: BUILD BACKEND (API + PACKAGES)
  # =================================================================================
  build-api:
    runs-on: ubuntu-latest
    environment: ANASLABS_VPS
    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v3
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter @alizzah/db generate

      # Build API also builds dependencies (db, shared, validators) via turbo
      - name: Build API
        run: |
          pnpm build --filter @alizzah/api
          # Also build API Client explicitly as it's not a dependency of API
          pnpm build --filter @alizzah/api-client

      # Prepare artifacts folder structure to make deployment easier
      - name: Prepare Artifacts
        run: |
          mkdir -p dist-package
          cp -r apps/api/dist dist-package/api-dist
          mkdir -p dist-package/packages
          cp -r packages/db/dist dist-package/packages/db-dist
          cp -r packages/shared/dist dist-package/packages/shared-dist
          cp -r packages/validators/dist dist-package/packages/validators-dist
          cp -r packages/api-client/dist dist-package/packages/api-client-dist
          cp ecosystem.config.cjs dist-package/

      - name: Upload API Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api-build
          path: dist-package/
          retention-days: 1

  # =================================================================================
  # JOB 3: DEPLOY (RSYNC + RELOAD)
  # =================================================================================
  deploy:
    needs: [build-web, build-api]
    runs-on: ubuntu-latest
    environment: ANASLABS_VPS
    
    steps:
      - name: Download Web Artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web-output

      - name: Download API Artifacts
        uses: actions/download-artifact@v4
        with:
          name: api-build
          path: api-dist-package

      - name: Prepare SSH Key
        env:
          VPS_KEY: ${{ secrets.VPS_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$VPS_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts

      - name: Sync Files to VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          # Sync Web Output
          rsync -avz --delete ./web-output/ $VPS_USER@$VPS_HOST:~/alizzah/apps/web-keuangan/.output/
          
          # Sync API Dist
          rsync -avz --delete ./api-dist-package/api-dist/ $VPS_USER@$VPS_HOST:~/alizzah/apps/api/dist/
          
          # Sync Packages Dist
          rsync -avz --delete ./api-dist-package/packages/db-dist/ $VPS_USER@$VPS_HOST:~/alizzah/packages/db/dist/
          rsync -avz --delete ./api-dist-package/packages/shared-dist/ $VPS_USER@$VPS_HOST:~/alizzah/packages/shared/dist/
          rsync -avz --delete ./api-dist-package/packages/validators-dist/ $VPS_USER@$VPS_HOST:~/alizzah/packages/validators/dist/
          rsync -avz --delete ./api-dist-package/packages/api-client-dist/ $VPS_USER@$VPS_HOST:~/alizzah/packages/api-client/dist/
          
          # Sync Config
          rsync -avz ./api-dist-package/ecosystem.config.cjs $VPS_USER@$VPS_HOST:~/alizzah/

      - name: Reload Application on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
             # Load NVM (Node Version Manager)
             export NVM_DIR="$HOME/.nvm"
             [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

             # Ensure pnpm is in PATH
             export PATH=$HOME/.local/share/pnpm:$PATH
             
             cd ~/alizzah
             
             # Pull only for package.json updates
             git fetch origin main
             git reset --hard origin/main
             
             # Symlinks (Safety Check)
             ln -sf .env apps/api/.env
             ln -sf ../../.env apps/web-keuangan/.env
             ln -sf ../../.env packages/db/.env

             # Install dependencies (only production)
             pnpm install --prod --ignore-scripts
             
             # Reload PM2
             pm2 reload ecosystem.config.cjs
             pm2 save
