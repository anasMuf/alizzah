name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ANASLABS_VPS
    
    env:
      VITE_API_URL: http://${{ secrets.VPS_HOST }}:3001/api/v1
      VPS_HOST: ${{ secrets.VPS_HOST }}
      VPS_USER: ${{ secrets.VPS_USER }}
      VPS_KEY: ${{ secrets.VPS_KEY }}

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v3
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm --filter @alizzah/db generate

      - name: Create .env file for Web Build
        run: |
          echo "VITE_API_URL=http://${{ secrets.VPS_HOST }}:3001/api/v1" > .env
          cat .env

      - name: Build all packages
        run: pnpm build

      - name: Check Output Folders
        run: |
          echo "=== Web Output ==="
          ls -la apps/web-keuangan/.output 2>/dev/null || ls -la apps/web-keuangan/dist 2>/dev/null || echo "No web output found"
          echo "=== API Output ==="
          ls -la apps/api/dist || echo "No API dist found"
          echo "=== DB Package ==="
          ls -la packages/db/dist || echo "No DB dist found"
          ls -la packages/db/generated/prisma || echo "No Prisma generated found"

      - name: Prepare SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "$VPS_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts

      - name: Sync Build Artifacts to VPS
        run: |
          # Sync Web Output
          if [ -d "apps/web-keuangan/.output" ]; then
             rsync -avz --delete ./apps/web-keuangan/.output/ $VPS_USER@$VPS_HOST:~/alizzah/apps/web-keuangan/.output/
          elif [ -d "apps/web-keuangan/dist" ]; then
             rsync -avz --delete ./apps/web-keuangan/dist/ $VPS_USER@$VPS_HOST:~/alizzah/apps/web-keuangan/dist/
          else
             echo "ERROR: No web build output found!"
             exit 1
          fi
          
          # Sync API Source (API now runs from source via tsx)
          rsync -avz --delete ./apps/api/src/ $VPS_USER@$VPS_HOST:~/alizzah/apps/api/src/
          
          # Sync Packages Source (db uses source exports)
          rsync -avz --delete ./packages/db/src/ $VPS_USER@$VPS_HOST:~/alizzah/packages/db/src/
          rsync -avz --delete ./packages/db/prisma/ $VPS_USER@$VPS_HOST:~/alizzah/packages/db/prisma/
          
          # Sync Packages Dist (shared, validators, api-client still use dist)
          rsync -avz --delete ./packages/shared/dist/ $VPS_USER@$VPS_HOST:~/alizzah/packages/shared/dist/
          rsync -avz --delete ./packages/validators/dist/ $VPS_USER@$VPS_HOST:~/alizzah/packages/validators/dist/
          rsync -avz --delete ./packages/api-client/dist/ $VPS_USER@$VPS_HOST:~/alizzah/packages/api-client/dist/
          
          # Sync package.json files (for module resolution)
          rsync -avz ./packages/db/package.json $VPS_USER@$VPS_HOST:~/alizzah/packages/db/
          rsync -avz ./packages/shared/package.json $VPS_USER@$VPS_HOST:~/alizzah/packages/shared/
          rsync -avz ./packages/validators/package.json $VPS_USER@$VPS_HOST:~/alizzah/packages/validators/
          rsync -avz ./packages/api-client/package.json $VPS_USER@$VPS_HOST:~/alizzah/packages/api-client/
          rsync -avz ./apps/api/package.json $VPS_USER@$VPS_HOST:~/alizzah/apps/api/
          rsync -avz ./apps/web-keuangan/package.json $VPS_USER@$VPS_HOST:~/alizzah/apps/web-keuangan/
          
          # Sync root config files
          rsync -avz ./ecosystem.config.cjs $VPS_USER@$VPS_HOST:~/alizzah/
          rsync -avz ./package.json $VPS_USER@$VPS_HOST:~/alizzah/
          rsync -avz ./pnpm-workspace.yaml $VPS_USER@$VPS_HOST:~/alizzah/
          rsync -avz ./pnpm-lock.yaml $VPS_USER@$VPS_HOST:~/alizzah/

      - name: Reload Application on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          script: |
             # Load NVM
             export NVM_DIR="$HOME/.nvm"
             [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

             # Ensure pnpm is in PATH
             export PATH=$HOME/.local/share/pnpm:$PATH
             
             cd ~/alizzah
             
             # Create .env symlinks if not exist
             ln -sf ../../.env apps/api/.env 2>/dev/null || true
             ln -sf ../../.env apps/web-keuangan/.env 2>/dev/null || true
             ln -sf ../../.env packages/db/.env 2>/dev/null || true

             # Install Deps (need devDependencies for prisma generate)
             pnpm install --ignore-scripts
             
             # Generate Prisma Client for VPS (gets correct binary engine for debian)
             cd packages/db && pnpm generate && cd ../..
             
             # Reload PM2
             pm2 reload ecosystem.config.cjs
             pm2 save
